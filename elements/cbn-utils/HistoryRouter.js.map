{"version":3,"file":"HistoryRouter.js","sourceRoot":"","sources":["HistoryRouter.ts"],"names":[],"mappings":"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","sourcesContent":["export type Page = {\n    page: string;\n    _id?: string;\n    model?: Object,\n    pathname: string\n}\n\n\nexport class HistoryRouter {\n    urls: Page[] = [];\n    onShowPage: Function = () => {}\n    base:string=\"\"\n    home:string=\"\"\n\n    constructor({ onShowPage, base, home}:{base?:string, home?:string, onPopState:Function, onShowPage:Function}) {\n        this.onShowPage = onShowPage;\n        this.base = base ?? \"\";\n        this.home = home ?? \"\";\n        console.log(base, home)\n        window.addEventListener('popstate', this._onPopstate.bind(this));\n        window.addEventListener('show-page', this._showPage.bind(this));\n    }\n\n    pushState(data: any, unused: string, url: string) {\n        let page = this.getCurrentPageFromPath(url, data)\n        this.urls.push(page)\n        window.history.pushState(this.urls.length - 1, unused, page.pathname);\n        this.onShowPage(this.urls[this.urls.length - 1])\n    }\n\n    replaceState(data: any, unused: string, url: string) {\n        let page = this.getCurrentPageFromPath(url, data);\n        if (this.urls.length > 0) {\n            this.urls[this.urls.length - 1] = page\n        } else {\n            this.urls.push(page)\n        }\n\n        window.history.replaceState(this.urls.length - 1, unused, page.pathname);\n        this.onShowPage(this.urls[this.urls.length - 1])\n    }\n\n    back() {\n        if (this.urls.length > 1) {\n            this.urls.pop();\n            window.history.back();\n            this.onShowPage(this.urls[this.urls.length - 1])\n        } else {\n            this.pushState(null, null, this.home);\n        }\n    }\n\n    forward() {\n        window.history.forward();\n        let page = this.getCurrentPageFromPath(window.location.href);\n        this.urls.push(page);\n        this.onShowPage(this.urls[this.urls.length - 1])\n    }\n\n    _onPopstate(event: PopStateEvent) {\n        if (event.state > this.urls.length - 1) {\n            console.log(\"forward\", event.state);\n            let page = this.getCurrentPageFromPath(window.location.pathname);\n            this.urls.push(page);\n            this.onShowPage(this.urls[this.urls.length - 1])\n        } else {\n            console.log(\"back\", event.state);\n            this.urls.length = event.state + 1;\n            this.replaceState(null,null,window.location.pathname)\n        }\n    }\n    getCurrentPageFromPath(pathname:string, model:any={}) {\n        pathname = (pathname.replace(/[/]/g, '') !== this.base || !this.base && pathname.replace(/[/]/g, '').length > 0) ? pathname : this.base?`/${this.base}${this.home}`: this.home;\n        // @ts-ignore\n        let globalParams = window.data.globalParams || {};\n        // @ts-ignore\n        let params = Object.entries(globalParams).filter(([key, value]) => value !== undefined).map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`);\n        let param = \"\"\n        if (params.length > 0) {\n            param = \"&\" + params.join(\"&\");\n        }\n        // @ts-ignore\n        let url = `${pathname}?_companyId=${encodeURIComponent(window.data._selectedCompany)}${param}`;\n\n        let splits = pathname.split('/').filter(item => item !== '' && item !== this.base);\n        return {\n            page: decodeURIComponent(splits[0]),\n            _id: splits[1] === undefined ? undefined : decodeURIComponent(splits[1]),\n            model: model,\n            pathname: url\n        } as Page;\n    }\n\n    _showPage(e: CustomEvent<Page>): void {\n        let {page, _id, ...model} = e.detail;\n        page = `${this.base ? \"/\" + this.base : \"\"}/${page}${_id ? `/${_id}` : ''}`;\n        this.pushState(e.detail, null, page)\n        this.onShowPage(this.urls[this.urls.length - 1])\n    }\n\n    showPage(url: string, data?: any) {\n        if (this.base && !url.startsWith(\"/\" + this.base)) {\n            url = `/${this.base}/${url}`\n        }\n        this.pushState(data, null, url);\n    }\n}"]}